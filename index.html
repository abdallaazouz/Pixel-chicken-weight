<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… ØªÙ‚Ø¯ÙŠØ± ÙˆØ²Ù† Ø§Ù„ÙØ±Ø§Ø® Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</title>

<!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0"></script>
<script src="https://docs.opencv.org/4.x/opencv.js"></script>

<!-- ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… -->
<style>
body {
  font-family: "Cairo", Tahoma, sans-serif;
  background: linear-gradient(to bottom right, #f9f9f2, #e2f1e5);
  color: #2f2f2f;
  text-align: center;
  direction: rtl;
  margin: 0;
  padding: 0;
}

header {
  background: #4a7a2f;
  color: white;
  padding: 15px 0;
  font-size: 22px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.container {
  padding: 20px;
  max-width: 700px;
  margin: auto;
}

input, button {
  margin: 8px;
  padding: 10px 14px;
  font-size: 17px;
  border-radius: 8px;
  border: 1px solid #ccc;
  outline: none;
}

input[type="file"] {
  border: none;
  background: none;
}

button {
  background: #6ca33b;
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

button:hover {
  background: #4a7a2f;
}

#canvas {
  width: 100%;
  max-width: 100%;
  border: 3px solid #4a7a2f;
  border-radius: 15px;
  margin-top: 15px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

#output {
  background: #f1f9f3;
  border-radius: 12px;
  margin-top: 20px;
  padding: 15px;
  font-size: 18px;
  color: #225a1a;
  line-height: 1.8;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

footer {
  background: #4a7a2f;
  color: white;
  padding: 15px;
  margin-top: 30px;
  font-size: 15px;
}

footer a {
  color: #fff;
  margin: 0 8px;
  text-decoration: none;
  font-weight: bold;
}

footer a:hover {
  text-decoration: underline;
}
</style>
</head>
<body>

<header>ğŸ” Ù†Ø¸Ø§Ù… ØªÙ‚Ø¯ÙŠØ± ÙˆØ²Ù† ÙˆØ¹Ø¯Ø¯ Ø§Ù„ÙØ±Ø§Ø® Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</header>

<div class="container">
  <h3>ğŸ“· Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙØ±Ø§Ø® Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ø¶</h3>
  
  <input type="file" id="imageInput" accept="image/*">
  <br>
  <label>ğŸ“ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø³Ù…): </label>
  <input type="number" id="heightInput" value="100" min="20" max="300">
  <br>
  <button id="processBtn">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>

  <canvas id="canvas"></canvas>

  <div id="output"></div>
</div>

<footer>
  ğŸ§  ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: <strong>Ù…. Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø¹Ø²ÙˆØ²</strong>  
  <br> 
  ğŸ’¬ <a href="https://wa.me/201000000000" target="_blank">ÙˆØ§ØªØ³Ø§Ø¨01119935714</a>
</footer>

<script>
let net;
const DEFAULT_HEIGHT = 100;
const PIXEL_TO_WEIGHT = 0.00005;

async function loadModel() {
  net = await bodyPix.load();
  console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ BodyPix Ø¨Ù†Ø¬Ø§Ø­");
}

async function processImage() {
  const file = document.getElementById('imageInput').files[0];
  if (!file) return alert("ğŸ“¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
  
  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = async () => {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    // ØªÙ†ÙÙŠØ° Ø§Ù„ÙØµÙ„ Ø§Ù„Ø°ÙƒÙŠ
    const segmentation = await net.segmentMultiPerson(img, {
      internalResolution: 'medium',
      segmentationThreshold: 0.6
    });

    const coloredPartImage = bodyPix.toMask(
      segmentation, 
      {r:0,g:0,b:0,a:0}, 
      {r:255,g:255,b:255,a:255}, 
      true
    );

    await bodyPix.drawMask(canvas, img, coloredPartImage, 0.7, 0);

    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ OpenCV
    let src = cv.imread(canvas);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    cv.threshold(gray, gray, 127, 255, cv.THRESH_BINARY);

    // ØªÙ†Ù‚ÙŠØ© Ø§Ù„ØµÙˆØ±Ø©
    let kernel = cv.Mat.ones(5, 5, cv.CV_8U);
    cv.morphologyEx(gray, gray, cv.MORPH_OPEN, kernel);
    cv.morphologyEx(gray, gray, cv.MORPH_CLOSE, kernel);

    // Ø¹Ø¯ Ø§Ù„Ø£Ø¬Ø³Ø§Ù…
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let totalPixels = 0;
    let validCount = 0;

    for (let i = 0; i < contours.size(); ++i) {
      let area = cv.contourArea(contours.get(i));
      if (area > 5000) {
        totalPixels += area;
        validCount++;
        cv.drawContours(src, contours, i, [0, 255, 0, 255], 3);
      }
    }

    const H = parseFloat(document.getElementById('heightInput').value);
    const weight = totalPixels * PIXEL_TO_WEIGHT * Math.pow(H / DEFAULT_HEIGHT, 2);

    document.getElementById('output').innerHTML = `
      ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ø§Ø® Ø§Ù„Ù…ÙƒØªØ´ÙØ©: <strong>${validCount}</strong><br>
      âš–ï¸ Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: <strong>${weight.toFixed(2)} ÙƒØ¬Ù…</strong><br>
      ğŸ“ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${H} Ø³Ù… (Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ ${DEFAULT_HEIGHT} Ø³Ù…)
    `;

    cv.imshow('canvas', src);
    src.delete(); gray.delete(); kernel.delete(); contours.delete(); hierarchy.delete();
  };
}

loadModel();
document.getElementById('processBtn').addEventListener('click', processImage);
</script>

</body>
</html>